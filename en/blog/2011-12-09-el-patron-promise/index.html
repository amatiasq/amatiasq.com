<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <meta name="theme-color" content="#121212">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>Promise pattern (spanish) | A. Mat√≠as Quezada</title>
    
<meta name="astro-view-transitions-enabled" content="true">
<meta name="astro-view-transitions-fallback" content="animate">
<script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.rasoniT7.js"></script>
  <link rel="stylesheet" href="/_astro/_slug_.eUhtq0iF.css">
<style>time:where(.astro-zcsldidg){font-family:ui-monospace,SF Mono,Menlo,Monaco,Courier New,monospace;font-size:.9em}
.md .code-block{position:relative;margin:1.5rem 0}.md pre{padding:1.25rem;border-radius:8px;overflow-x:auto;border:1px solid oklch(28% 0 0);margin:0}.md pre code{font-family:ui-monospace,SF Mono,Menlo,Monaco,Courier New,monospace;font-size:.875rem;line-height:1.6}.md :not(pre)>code{font-family:ui-monospace,SF Mono,Menlo,Monaco,Courier New,monospace;background:#090909;padding:.2em .4em;border-radius:4px;font-size:.9em;border:1px solid oklch(28% 0 0)}.md h2,.md h3{margin-top:2.5rem;margin-bottom:1rem}.md p{margin:1rem 0}.md blockquote{border-left:3px solid oklch(28% 0 0);margin:1.5rem 0;padding:.5rem 1rem;background:#090909;border-radius:0 8px 8px 0}.md blockquote p{margin:.5rem 0;color:#8f8f8f}.md ul,.md ol{padding-left:1.5rem;margin:1rem 0}.md li{margin:.5rem 0}.md hr{border:none;border-top:1px solid oklch(28% 0 0);margin:2rem 0}.md img{max-width:100%;height:auto;display:block;margin:1.5rem 0}.md pre span[style*="color:#6A737D"],.md pre span[style*="color:#8b949e"]{color:#54b05a!important;font-style:italic}.tags:where(.astro-hfj6urh3){list-style:none;padding:0;margin:1rem 0;display:flex;flex-wrap:wrap;gap:.5rem}li:where(.astro-hfj6urh3) .tag-link{background:#121212;border:1px solid oklch(28% 0 0);border-radius:4px;padding:.2rem .6rem;margin:0;font-size:.8rem;color:#9e9e9e;text-decoration:none;transition:all .15s ease;display:inline-block}li:where(.astro-hfj6urh3) .tag-link:hover{background:#222;border-color:var(--accent);color:var(--accent);transform:none}
@keyframes astroFadeInOut{0%{opacity:1}to{opacity:0}}@keyframes astroFadeIn{0%{opacity:0;mix-blend-mode:plus-lighter}to{opacity:1;mix-blend-mode:plus-lighter}}@keyframes astroFadeOut{0%{opacity:1;mix-blend-mode:plus-lighter}to{opacity:0;mix-blend-mode:plus-lighter}}@keyframes astroSlideFromRight{0%{transform:translate(100%)}}@keyframes astroSlideFromLeft{0%{transform:translate(-100%)}}@keyframes astroSlideToRight{to{transform:translate(100%)}}@keyframes astroSlideToLeft{to{transform:translate(-100%)}}@media (prefers-reduced-motion){::view-transition-group(*),::view-transition-old(*),::view-transition-new(*){animation:none!important}[data-astro-transition-scope]{animation:none!important}}
</style><style>[data-astro-transition-scope="astro-dsji2kxr-1"] { view-transition-name: title-2011-12-09-el-patron-promise; }@layer astro { ::view-transition-old(title-2011-12-09-el-patron-promise) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(title-2011-12-09-el-patron-promise) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(title-2011-12-09-el-patron-promise) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(title-2011-12-09-el-patron-promise) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-dsji2kxr-1"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-dsji2kxr-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-dsji2kxr-1"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-dsji2kxr-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-dsji2kxr-1"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-dsji2kxr-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-dsji2kxr-1"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-dsji2kxr-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-vpr6a7he-2"] { view-transition-name: tag-javascript; }@layer astro { ::view-transition-old(tag-javascript) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(tag-javascript) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(tag-javascript) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(tag-javascript) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-vpr6a7he-2"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-vpr6a7he-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-vpr6a7he-2"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-vpr6a7he-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-vpr6a7he-2"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-vpr6a7he-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-vpr6a7he-2"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-vpr6a7he-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style></head>
  <body>
    
  <header class="astro-np5jgbit">
  <a href="/en/" class="site-title astro-np5jgbit"><span class="a-matias-quezada astro-np5jgbit astro-2dpizvyk">
  <abbr class="astro-2dpizvyk">Adrian</abbr>
  <span class="dot astro-2dpizvyk">.</span>
  <span class="astro-2dpizvyk">Mat√≠as Quezada</span>
</span></a>
  <nav class="astro-np5jgbit">
    <a href="/en/projects/" class="astro-np5jgbit">Projects</a>
    <span class="sep astro-np5jgbit">¬∑</span>
    <a href="/en/blog/" class="astro-np5jgbit">Blog</a>
    <span class="sep astro-np5jgbit">¬∑</span>
    <a href="/en/experiments/" class="astro-np5jgbit">Experiments</a>
    <span class="sep astro-np5jgbit">¬∑</span>
    <a href="/en/talks/" class="astro-np5jgbit">Talks</a>
    <span class="sep astro-np5jgbit">¬∑</span>
    <a href="/en/career/" class="astro-np5jgbit">Career</a>
    <span class="sep astro-np5jgbit">|</span>
    <a href="https://github.com/amatiasq" title="GitHub" class="icon-link astro-np5jgbit">
      <svg aria-label="GitHub" width="20" height="20" viewBox="0 0 98 96" xmlns="http://www.w3.org/2000/svg" class="astro-np5jgbit">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z" fill="currentColor" class="astro-np5jgbit"></path>
      </svg>
    </a>
    <a href="/es/blog/2011-12-09-el-patron-promise/" title="Espa√±ol" class="lang-switch astro-bzi5jpwk" data-lang="es">
  üá™üá∏
</a>



<script type="module">function n(){const t=document.querySelector(".lang-switch");if(!t)return;const a=t.dataset.lang,e=Intl.DateTimeFormat().resolvedOptions().timeZone.startsWith("America/");a==="en"?(t.textContent=e?"üá∫üá∏":"üá¨üáß",t.title="English"):(t.textContent=e?"üá¶üá∑":"üá™üá∏",t.title="Espa√±ol")}n();document.addEventListener("astro:after-swap",n);</script>
  </nav>
</header>
<hr class="astro-np5jgbit">
  <main>
    <article>
      <header>
        <h1 data-astro-transition-scope="astro-dsji2kxr-1">Promise pattern (spanish)</h1>
        <time datetime="2011-12-09T00:00:00.000Z" class="astro-zcsldidg">Dec 09, 2011</time>
        <ul class="tags astro-hfj6urh3">
    <li class="astro-hfj6urh3">
        <a href="/en/tag/javascript/" class="tag-link astro-hfj6urh3">
          <span class="astro-hfj6urh3" data-astro-transition-scope="astro-vpr6a7he-2">
            Javascript
          </span>
        </a>
      </li>
  </ul>


      </header>
      <div class="md "><blockquote>
<p>Actualizaci√≥n 19/3/2014: Finalmente los promises se han confirmado <a href="https://github.com/lukehoban/es6features#promises">para el est√°ndar ECMAScript 6</a>, dentro de poco ser√°n nativos en Javascript :D</p>
<p>Actualizaci√≥n 7/10/2016: Los promises <a href="https://developer.mozilla.org/es/docs/Web/JavaScript/Referencia/Objetos_globales/Promesa">ya son est√°ndar</a> y est√°n implementados <a href="http://caniuse.com/#search=promises">en los navegadores</a>!!!</p>
</blockquote>
<h2>PROBLEMA</h2>
<p>Recientemente he tenido que implementar un sistema MVC en Javascript para simplificar el desarrollo sobre una plataforma y me he encontrado con el problema de que las llamadas as√≠ncronas a servidor romp√≠an la simpleza del c√≥digo, tras un an√°lisis identifiqu√© cuatro problemas:</p>
<!-- end extract -->

<h4>1 - Ensuciar la API</h4>
<p>Todas las llamadas reciben un √∫ltimo argumento que es el callback:</p>
<div class="code-block"><pre class="shiki github-dark" style="background-color:#24292e;color:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> dir </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Directory</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'file:///home/user/Desktop'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">dir.</span><span style="color:#B392F0">browse</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">dir</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">items</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">  // ...</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre></div><p>Con √©sto la API resulta confusa desde el punto de vista de la simpleza y de la sem√°ntica. Sem√°nticamente una funci√≥n recibe la informaci√≥n m√≠nima indispensable para devolver un dato relacionado a lo que se le ha solicitado, como vemos no es el caso en m√©todos as√≠ncronos:</p>
<div class="code-block"><pre class="shiki github-dark" style="background-color:#24292e;color:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#F97583">void</span><span style="color:#E1E4E8"> Directory.</span><span style="color:#B392F0">browse</span><span style="color:#E1E4E8">(Function callback);</span></span>
<span class="line"><span style="color:#F97583">void</span><span style="color:#E1E4E8"> File.</span><span style="color:#B392F0">getContent</span><span style="color:#E1E4E8">(String encoding, Function callback);</span></span>
<span class="line"><span style="color:#F97583">void</span><span style="color:#E1E4E8"> File.</span><span style="color:#B392F0">getPermission</span><span style="color:#E1E4E8">(Function callback);</span></span></code></pre></div><!--more Seguir leyendo ‚Üí -->

<h3>2 - Llamadas anidadas</h3>
<p>En muchas ocaciones deberemos ejecutar una llamada al acabar otra, √©sto nos obliga a anidar callbacks:</p>
<div class="code-block"><pre class="shiki github-dark" style="background-color:#24292e;color:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> file </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> File</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">file.</span><span style="color:#B392F0">isReadable</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">permission</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (permission) {</span></span>
<span class="line"><span style="color:#E1E4E8">    file.</span><span style="color:#B392F0">getContent</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">content</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">      // do something with the content</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre></div><p>A medida que vamos a√±adiendo niveles de profundidad √©sto se vuelve muy confuso.</p>
<h3>3 - Llamadas concurrentes</h3>
<p>Tambi√©n necesitaremos realizar llamadas as√≠ncronas paralelas y ejecutar una acci√≥n al acabar todas:</p>
<div class="code-block"><pre class="shiki github-dark" style="background-color:#24292e;color:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> isFile1Done </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> isFile2Done </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> testIsOver</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (isFile1Done </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> isFile2Done) {</span></span>
<span class="line"><span style="color:#6A737D">    // Both files loaded.</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">File.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'http://www.somedomain.com/file1'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#E1E4E8">  isFile1Done </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">  testIsOVer</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"><span style="color:#E1E4E8">File.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'http://www.somedomain.com/file2'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#E1E4E8">  isFile2Done </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">  testIsOVer</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre></div><p>Como podemos ver algo tan sencillo como dos peticiones paralelas necesitan mucho c√≥digo para manejarlas.</p>
<h3>4 - Gesti√≥n de errores</h3>
<p>Es traum√°tica la forma de gestionar errores mediante callbacks, el m√©todo m√°s extendido que he visto ha sido el de nodejs, el primer argumento de cada callback es el objeto Error si es que hubo alguna excepci√≥n, lo que me parece horrible ya que cada funci√≥n debe confirmar que su primer argumento es <code>undefined</code> para asegurar que no han habido errores:</p>
<div class="code-block"><pre class="shiki github-dark" style="background-color:#24292e;color:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">File.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'http://www.somedomain.com/file2'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">error</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">file</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (error) {</span></span>
<span class="line"><span style="color:#6A737D">    // Show blue screen of death</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#6A737D">  // do something with file.</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre></div><h2>SOLUCION</h2>
<p>Queda claro que las peticiones as√≠ncronas son necesarias en cliente y servidor ya que permiten al programa continuar trabajando mientras espera la respuesta a la petici√≥n, pero √©stos problemas podr√≠an dificultar la manutenci√≥n del c√≥digo. Y aqu√≠ es donde viene a ayudarnos el Patr√≥n Promise. El patr√≥n Promise asiste a una funci√≥n que no puede devolver inmediatamente su resultado (es decir, una funci√≥n as√≠ncrona) y devuelve la promesa de que tendr√° el resultado en un futuro (a lo que llamo cumplir la promesa :P). A nivel de implementaci√≥n, una funci√≥n devuelve un objeto <strong>Promise</strong> que gestionar√° por ella el callback. Veamos c√≥mo soluciona nuestros problemas:</p>
<h4>1 - Claridad en los m√©todos</h4>
<p>La funci√≥n solo debe recibir la informaci√≥n necesaria para hacer la petici√≥n y devuelve la promesa de que esos datos llegar√°n.</p>
<div class="code-block"><pre class="shiki github-dark" style="background-color:#24292e;color:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> dir </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Directory</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'file:///home/user/Desktop'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> promise </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> dir.</span><span style="color:#B392F0">browse</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">promise.</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">dir</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">items</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">  // ...</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre></div><p>Y √©sto a√∫n lo podr√≠amos mejorar llamando directamente a la funci√≥n then sin guardar el promise en una variable:</p>
<div class="code-block"><pre class="shiki github-dark" style="background-color:#24292e;color:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> dir </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Directory</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'file:///home/user/Desktop'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">dir.</span><span style="color:#B392F0">browse</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">dir</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">items</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">  // ...</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre></div><p>Y muchos dir√°n ¬øqu√© diferencia hay entre √©sto y el c√≥digo que ten√≠amos antes? Es sencillo, la diferencia est√° en qui√©n maneja el callback. Con el c√≥digo anterior cada funci√≥n deb√≠a encargarse de comprobar si se le hab√≠a pasado un callback v√°lido y llamarlo al acabar su tarea con los argumentos necesarios. Ahora todo √©se c√≥digo est√° en la clase <code>Promise</code> y la funci√≥n puede encargarse de aquello que le corresponde siempre que devuelva un promise y le notifique cuando termine. Finalmente la API queda bastante m√°s clara:</p>
<div class="code-block"><pre class="shiki github-dark" style="background-color:#24292e;color:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#79B8FF">Promise</span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8">Array</span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8">File</span><span style="color:#F97583">>></span><span style="color:#E1E4E8"> Directory.</span><span style="color:#B392F0">browse</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#79B8FF">Promise</span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8">String</span><span style="color:#F97583">></span><span style="color:#E1E4E8"> File.</span><span style="color:#B392F0">getContent</span><span style="color:#E1E4E8">(String encoding);</span></span>
<span class="line"><span style="color:#79B8FF">Promise</span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8">Boolean</span><span style="color:#F97583">></span><span style="color:#E1E4E8"> File.</span><span style="color:#B392F0">getPermission</span><span style="color:#E1E4E8">();</span></span></code></pre></div><h3>2 - Llamadas secuenciales</h3>
<p>El promise trae una sorpresa que no me esperaba, el m√©todo <code>then</code> de la clase <code>Promise</code> devuelve un nuevo <code>promise</code>. Para qu√©? para poder ejecutar c√≥digo secuencialmente, veamoslo:</p>
<div class="code-block"><pre class="shiki github-dark" style="background-color:#24292e;color:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> file </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> File</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">file</span></span>
<span class="line"><span style="color:#E1E4E8">  .</span><span style="color:#B392F0">isReadable</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">  .</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">permission</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (permission) {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> file.</span><span style="color:#B392F0">getContent</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  })</span></span>
<span class="line"><span style="color:#E1E4E8">  .</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">content</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">    // do something with the content</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span></code></pre></div><p>Qu√© es √©sta locura? La idea es muy sencilla, pero es confusa porque la explicaci√≥n utiliza demasiadas veces la palabra <code>Promise</code>, primero expandiremos el c√≥digo para verlo m√°s claro:</p>
<div class="code-block"><pre class="shiki github-dark" style="background-color:#24292e;color:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> file </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> File</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> promise1 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> file.</span><span style="color:#B392F0">isReadable</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> promise2 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> promise1.</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">permission</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (permission) {</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> promise3 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> file.</span><span style="color:#B392F0">getContent</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> promise3;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">promise2.</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">content</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">  // do something with the content</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre></div><p>Debemos intentar seguirlo poco a poco, la llamada a llamada <code>file.isReadable()</code> nos devuelve <code>promise1</code>, y cuando llamamos al m√©todo then de <code>promise1</code> nos devuelve <code>promise2</code>. Cuando <code>promise1</code> termina se ejecuta el callback pasado y se descubre que el callback devuelve un nuevo <code>Promise</code>, <code>promise3</code>. Cuando <code>promise3</code> se cumpla (es decir pase a estado &quot;done&quot;) tambi√©n se cumplir√° el <code>promise2</code> ejecutando el callback que le han pasado. En resumen, podemos seguir a√±adiendo callbacks que se ejecutar√°n al acabar el anterior encadenando llamadas a then.</p>
<h3>3 - Llamadas paralelas</h3>
<p>Adem√°s me plante√© a√±adir la posibilidad de manejar llamadas paralelas desde <code>Promise</code>, puesto que ya hemos visto lo complejo que puede ser. Para √©sto a√±ad√≠ el m√©todo <code>and</code> al Promise:</p>
<div class="code-block"><pre class="shiki github-dark" style="background-color:#24292e;color:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">File.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'http://www.somedomain.com/file1'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">  .</span><span style="color:#B392F0">and</span><span style="color:#E1E4E8">(File.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'http://www.somedomain.com/file2'</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">  .</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#6A737D">    // Both files loaded.</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span></code></pre></div><p>Una vez m√°s expandamos el c√≥digo para ver m√°s claramente que est√° sucediendo:</p>
<div class="code-block"><pre class="shiki github-dark" style="background-color:#24292e;color:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> promise1 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> File.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'http://www.somedomain.com/file1'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> promise2 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> File.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'http://www.somedomain.com/file2'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> promise3 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> promise1.</span><span style="color:#B392F0">and</span><span style="color:#E1E4E8">(promise2);</span></span>
<span class="line"><span style="color:#E1E4E8">promise3.</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#6A737D">  // Both files loaded.</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre></div><p>Al expandirlo es m√°s f√°cil ver lo que sucede, todo <code>Promise</code> tiene un m√©todo <code>and</code> al que se le pasa otro <code>Promise</code>, y √©sto devuelve un nuevo <code>Promise</code> que se cumplir√° cuando los dos primeros est√©n cumplidos.</p>
<h3>4 - Callbacks espec√≠ficos</h3>
<p>Finalmente el patr√≥n Promise tambi√©n trae una mejora al problema de la gesti√≥n de errores, a√∫n no lo he mencionado pero el m√©todo <code>then</code> recibe dos argumentos: el primero el callback que ser√° llamado cuando el Promise se cumpla, el segundo otro callback que ser√° llamado si la ejecuci√≥n as√≠ncrona falla:</p>
<div class="code-block"><pre class="shiki github-dark" style="background-color:#24292e;color:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">File.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'http://www.somedomain.com/file2'</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#F97583">  function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">file</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">    // do something with file.</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#F97583">  function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">    // Show blue screen of death</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#E1E4E8">);</span></span></code></pre></div><p>Esto nos permite separar claramente la responsabilidad de cada funci√≥n y nos libera de la carga de comprobar errores.</p>
<h2>CONCLUSION</h2>
<p>Como vemos las llamadas secuenciales traen muchos inconvenientes, pero son principalmente consecuencias de no estar acostumbrados a la programaci√≥n as√≠ncrona, si lo estuvi√©ramos tendr√≠amos m√°s en mente patrones como Promise que como vemos nos ayuda a afrontar una programaci√≥n que ya de por s√≠ es complicada. En pr√≥ximos posts espero mostrar paso la implementaci√≥n de una clase Promise, nos vemos en la pr√≥xima.</p>
</div>
    </article>
  </main>

  </body></html>