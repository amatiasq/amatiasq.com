<!DOCTYPE html><html lang="en"><head><meta charSet="UTF-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>ECMAScript 5 _.extend (游쀯릖 only) | A. Mat칤as Quezada</title><style> *, *::before, *::after { box-sizing: border-box; } ul, ol { padding: 0; } body, h1, h2, h3, h4, p, ul, ol, li, figure, figcaption, blockquote, dl, dd { margin: 0; } body { min-height: 100vh; scroll-behavior: smooth; text-rendering: optimizeSpeed; line-height: 1.5; } ul, ol { list-style: none; } .md ul, .md ol { list-style: initial; padding: revert; } a:not([class]) { text-decoration-skip-ink: auto; } img { max-width: 100%; display: block; } article > * + * { margin-top: 1em; } input, button, textarea, select { font: inherit; } @media (prefers-reduced-motion: reduce) { * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } } </style><style> @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Lato:ital,wght@1,400;1,700&family=Montserrat:wght@400;700&display=swap'); :root { background-color: #263238; color: #FDFBF8; font-family: Lato, sans-serif; font-size: 18px; --border-color: #586369; } header, h1, h2, h3, h4, h5, h6 { font-family: Montserrat, sans-serif; } a { color: #EFE751; } .md p { margin: 20px 0; text-align: justify; } code { font-family: Fira Code, monospace; } .md .code-block { display: block; font-family: Fira Code, monospace; width: var(--available-width); padding-bottom: 10px; } .md h3 { margin-top: 20px; margin-bottom: 20px; } svg { fill: #FDFBF8; } </style><style> [class*=shj-lang-]{white-space:pre;margin:10px 0;border-radius:10px;padding:30px 20px;background:white;color:#112;box-shadow:0 0 5px #0001;text-shadow:none;font: 18px Consolas,Courier New,Monaco,Andale Mono,Ubuntu Mono,monospace;line-height:24px;box-sizing:border-box;max-width:min(100%,100vw)} .shj-inline{margin:0;padding:2px 5px;display:inline-block;border-radius:5px} [class*=shj-lang-]::selection, [class*=shj-lang-] ::selection{background:#bdf5} [class*=shj-lang-]>div{display:flex;overflow:auto} [class*=shj-lang-]>div :last-child{flex:1;outline:none} .shj-numbers{padding-left:5px;counter-reset:line} .shj-numbers div{padding-right:5px} .shj-numbers div:before{color:#999;display:block;content:counter(line);opacity:.5;text-align:right;margin-right:5px;counter-increment:line} .shj-syn-cmnt{font-style:italic} .shj-syn-err, .shj-syn-kwd{color:#e16} .shj-syn-num, .shj-syn-class{color:#f60} .shj-numbers, .shj-syn-cmnt{color:#999} .shj-syn-insert, .shj-syn-str{color:#7d8} .shj-syn-bool{color:#3bf} .shj-syn-type, .shj-syn-oper{color:#5af} .shj-syn-section, .shj-syn-func{color:#84f} .shj-syn-deleted, .shj-syn-var{color:#f44} .shj-oneline{padding:12px 10px} .shj-lang-http.shj-oneline .shj-syn-kwd{background:#25f;color:#fff;padding:5px 7px;border-radius:5px} .shj-multiline.shj-mode-header{padding:20px} .shj-multiline.shj-mode-header:before{content:attr(data-lang);color:#58f;display:block;padding:10px 20px;background:#58f3;border-radius:5px;margin-bottom:20px} [class*=shj-lang-]{color:#abb2bf;background:#161b22} [class*=shj-lang-]:before{color:#6f9aff} .shj-syn-deleted, .shj-syn-err, .shj-syn-var{color:#e06c75} .shj-syn-section, .shj-syn-oper, .shj-syn-kwd{color:#c678dd} .shj-syn-class{color:#e5c07b} .shj-numbers, .shj-syn-cmnt{color:#76839a} .shj-syn-insert{color:#98c379} .shj-syn-type{color:#56b6c2} .shj-syn-num, .shj-syn-bool{color:#d19a66} .shj-syn-str, .shj-syn-func{color:#61afef} </style><style>.css-zi0qjt{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;}
.css-1p4f3y5{display:grid;padding-top:20px;gap:12px;}
.css-2nd93p{padding:20px 0;margin-bottom:20px;background-color:#1B2225;color:#FDFBF8;border-bottom:2px solid #586369;}@media (min-width: 769px){.css-2nd93p{position:-webkit-sticky;position:sticky;top:0;z-index:1;}}
.css-17rdaxl{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}@media (min-width: 769px){.css-17rdaxl{-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}}
.css-eexrvx{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;gap:12px;}.css-eexrvx a{color:#EFE751;-webkit-text-decoration:none;text-decoration:none;margin-left:12px;border-bottom:1px solid transparent;-webkit-transform:translate(0px, 0px);-moz-transform:translate(0px, 0px);-ms-transform:translate(0px, 0px);transform:translate(0px, 0px);}.css-eexrvx a.parent{border-bottom:1px solid #586369;}.css-eexrvx a:hover{border-bottom:1px solid #EFE751;-webkit-transition:-webkit-transform 1s ease;transition:transform 1s ease;-webkit-transform:translate(0px, -3px);-moz-transform:translate(0px, -3px);-ms-transform:translate(0px, -3px);transform:translate(0px, -3px);}
.css-18wymod{--container-side-gap:1rem;--container-width:40rem;--container-sides-gap:calc(var(--container-side-gap) * 2);--available-width:min(
      calc(100vw - var(--container-sides-gap)),
      calc(var(--container-width) - var(--container-sides-gap))
    );max-width:var(--container-width);padding-left:var(--container-side-gap);padding-right:var(--container-side-gap);margin-left:auto;margin-right:auto;}@media (min-width: 769px){.css-18wymod{--container-width:50rem;--container-side-gap:3rem;}}@media (min-width: 1200px){.css-18wymod{--container-width:60rem;}}
.css-hlqr5i{font-size:24px;-webkit-text-decoration:none;text-decoration:none;color:#FFFFFF;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:baseline;-webkit-box-align:baseline;-ms-flex-align:baseline;align-items:baseline;letter-spacing:1px;}.css-hlqr5i abbr{display:inline-block;width:0.8em;margin-right:0.35em;overflow:hidden;-webkit-transition:width 0.3s ease;transition:width 0.3s ease;}.css-hlqr5i:hover abbr{width:3.75em;}
.css-187qu0u{font-family:Montserrat,sans-serif;font-weight:700;font-size:32px;}
.css-a9renj{opacity:0.8;font-family:Fira Code,monospace;color:#FDFBF8;}</style></head><body class=""><header class="css-2nd93p "><div class="css-17rdaxl css-18wymod"><h2><a href="../.." class="css-hlqr5i"><abbr>Adrian</abbr> Mat칤as Quezada</a></h2><nav class="css-eexrvx"><a href=".." class="">Blog</a><a href="../../career" class="">Career</a><a href="../../projects" class="">Projects</a><a href="../../es/blog/2013-04-30-ecmascript5-extend" class="">游쀯릖</a></nav></div></header><div class="css-1p4f3y5 css-18wymod"><div class="css-zi0qjt"><h2 class="undefined css-187qu0u">ECMAScript 5 _.extend (游쀯릖 only)</h2><time class="css-a9renj " dateTime="04/30/2013">Apr 30, 2013</time></div><article><div class="md"><p>A algunos ya os he comentado los problemas que <a href="http://www.nczonline.net/blog/2012/12/11/are-your-mixins-ecmascript-5-compatible/">NC Zakas comenta</a> con el <code>_.extend</code> de underscore y los getters:</p>

<code class="code-block shj-lang-js"><div><div class="shj-numbers"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div><span class="shj-syn-kwd">var</span> a <span class="shj-syn-oper">=</span> {
  init<span class="shj-syn-oper">:</span> <span class="shj-syn-kwd">function</span> () {
    <span class="shj-syn-kwd">this</span><span class="shj-syn-oper">.</span>list <span class="shj-syn-oper">=</span> [];
  }<span class="shj-syn-oper">,</span>

  <span class="shj-syn-kwd">get</span> <span class="shj-syn-func">first</span>() {
    <span class="shj-syn-kwd">return</span> <span class="shj-syn-kwd">this</span><span class="shj-syn-oper">.</span>list[<span class="shj-syn-num">0</span>];
  }<span class="shj-syn-oper">,</span>
};</div></div>
</code>
<!-- end extract -->
<p>O</p>

<code class="code-block shj-lang-js"><div><div class="shj-numbers"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div><span class="shj-syn-kwd">var</span> a <span class="shj-syn-oper">=</span> {
  init<span class="shj-syn-oper">:</span> <span class="shj-syn-kwd">function</span> () {
    <span class="shj-syn-kwd">this</span><span class="shj-syn-oper">.</span>list <span class="shj-syn-oper">=</span> [];
  }<span class="shj-syn-oper">,</span>
};

<span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">defineProperty</span>(a<span class="shj-syn-oper">,</span> <span class="shj-syn-str">'first'</span><span class="shj-syn-oper">,</span> {
  <span class="shj-syn-kwd">get</span><span class="shj-syn-oper">:</span> <span class="shj-syn-kwd">function</span> () {
    <span class="shj-syn-kwd">return</span> <span class="shj-syn-kwd">this</span><span class="shj-syn-oper">.</span>list[<span class="shj-syn-num">0</span>];
  }<span class="shj-syn-oper">,</span>
});</div></div>
</code>
<p>Y que si hacemos <code>_.extend(a)</code> va a fallar porque intentar치 hacer <code>result.first = a.first</code> ejecutando el getter. Pero como a칰n no hemos llamado al <code>.init()</code> en <code>a</code> porque solo es un prototipo, la propiedad <code>.list</code> es undefined produciendo un error.</p>
<p>Pues bien, yo cre칤a que esto se solucionaba extrayendo el descriptor de la propiedad y usando ese mismo descriptor para copiar la propiedad al nuevo objeto:</p>

<code class="code-block shj-lang-js"><div><div class="shj-numbers"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div><span class="shj-syn-kwd">function</span> <span class="shj-syn-func">extend</span>(obj) {
  <span class="shj-syn-kwd">var</span> result <span class="shj-syn-oper">=</span> {};
  <span class="shj-syn-kwd">var</span> properties <span class="shj-syn-oper">=</span> <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">keys</span>(obj);

  properties<span class="shj-syn-oper">.</span><span class="shj-syn-func">forEach</span>(<span class="shj-syn-kwd">function</span> (prop) {
    <span class="shj-syn-kwd">var</span> descriptor <span class="shj-syn-oper">=</span> <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">getOwnPropertyDescriptor</span>(obj<span class="shj-syn-oper">,</span> prop);
    <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">defineProperty</span>(result<span class="shj-syn-oper">,</span> prop<span class="shj-syn-oper">,</span> descriptor);
  });

  <span class="shj-syn-kwd">return</span> result;
}</div></div>
</code>
<p>Pero he usado esto en la librer칤a de promises y me he dado cuenta que solo hereda las propiedades directas, tanto <code>Object.keys</code> como <code>Object.getOwnPropertyDescriptor</code> solo funcionan si la propiedad est치 directamente declarada en el objeto y no en ninguno de sus prototipos. Y no hay ninguna forma de decir <code>Object.getPropertyDescriptorFromHimOrHisPrototypes()</code> as칤 que la 칰nica forma es recorrer todos los prototipos.</p>

<code class="code-block shj-lang-js"><div><div class="shj-numbers"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div><span class="shj-syn-kwd">function</span> <span class="shj-syn-func">extend</span>(obj) {
  <span class="shj-syn-kwd">var</span> result <span class="shj-syn-oper">=</span> {};
  <span class="shj-syn-kwd">var</span> proto <span class="shj-syn-oper">=</span> obj;

  <span class="shj-syn-kwd">while</span> (proto) {
    <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">keys</span>(proto)<span class="shj-syn-oper">.</span><span class="shj-syn-func">forEach</span>(<span class="shj-syn-kwd">function</span> (prop) {
      <span class="shj-syn-kwd">var</span> descriptor <span class="shj-syn-oper">=</span> <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">getOwnPropertyDescriptor</span>(proto<span class="shj-syn-oper">,</span> prop);
      <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">defineProperty</span>(result<span class="shj-syn-oper">,</span> prop<span class="shj-syn-oper">,</span> descriptor);
    });

    proto <span class="shj-syn-oper">=</span> <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">getPrototypeOf</span>(proto);
  }

  <span class="shj-syn-kwd">return</span> result;
}</div></div>
</code>
<p>Pero eso tampoco funciona del todo bien porque las propiedades de los ancestros se impondr칤an sobre las propiedades propias del objeto. As칤 que primero hay que empezar por el 칰ltimo prototipo y acabar por el propio objeto</p>

<code class="code-block shj-lang-js"><div><div class="shj-numbers"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div><span class="shj-syn-kwd">function</span> <span class="shj-syn-func">extend</span>(obj) {
  <span class="shj-syn-kwd">var</span> result <span class="shj-syn-oper">=</span> {};
  <span class="shj-syn-kwd">var</span> proto <span class="shj-syn-oper">=</span> obj;
  <span class="shj-syn-kwd">var</span> protos <span class="shj-syn-oper">=</span> [];

  <span class="shj-syn-kwd">while</span> (proto) {
    protos<span class="shj-syn-oper">.</span><span class="shj-syn-func">push</span>(proto);
    proto <span class="shj-syn-oper">=</span> <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">getPrototypeOf</span>(proto);
  }

  protos<span class="shj-syn-oper">.</span><span class="shj-syn-func">reverse</span>()<span class="shj-syn-oper">.</span><span class="shj-syn-func">forEach</span>(<span class="shj-syn-kwd">function</span> (ancestor) {
    <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">keys</span>(ancestor)<span class="shj-syn-oper">.</span><span class="shj-syn-func">forEach</span>(<span class="shj-syn-kwd">function</span> (prop) {
      <span class="shj-syn-kwd">var</span> descriptor <span class="shj-syn-oper">=</span> <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">getOwnPropertyDescriptor</span>(ancestor<span class="shj-syn-oper">,</span> prop);
      <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">defineProperty</span>(result<span class="shj-syn-oper">,</span> prop<span class="shj-syn-oper">,</span> descriptor);
    });
  });

  <span class="shj-syn-kwd">return</span> result;
}</div></div>
</code>
<p>Y esto ya funciona, pero le falta un detallito, mediante el property descriptor se puede poner que una propiedad no sea enumerable por lo que no se interar치 sobre ella con un <code>for .. in ..</code> ni con <code>Object.keys</code> pero si las podemos obtener si utilizamos <code>Object.getOwnPropertyNames</code> (Fuente: <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Object/getOwnPropertyNames">MDN</a>). As칤 que remplazando <code>Object.keys</code> con <code>Object.getOwnPropertyNames</code> esta vez si (espero, rezo, suplico -.-) tenemos una funci칩n que crea una copia de todas las propiedades propias y heredadas de un objeto.</p>

<code class="code-block shj-lang-js"><div><div class="shj-numbers"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div><span class="shj-syn-kwd">function</span> <span class="shj-syn-func">ecma5extend</span>(obj) {
  <span class="shj-syn-kwd">var</span> proto <span class="shj-syn-oper">=</span> obj;
  <span class="shj-syn-kwd">var</span> protos <span class="shj-syn-oper">=</span> [];
  <span class="shj-syn-kwd">var</span> result <span class="shj-syn-oper">=</span> {};

  <span class="shj-syn-kwd">while</span> (proto) {
    protos<span class="shj-syn-oper">.</span><span class="shj-syn-func">push</span>(proto);
    proto <span class="shj-syn-oper">=</span> <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">getPrototypeOf</span>(proto);
  }

  protos<span class="shj-syn-oper">.</span><span class="shj-syn-func">reverse</span>()<span class="shj-syn-oper">.</span><span class="shj-syn-func">forEach</span>(<span class="shj-syn-kwd">function</span> (ancestor) {
    <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">getOwnPropertyNames</span>(ancestor)<span class="shj-syn-oper">.</span><span class="shj-syn-func">forEach</span>(<span class="shj-syn-kwd">function</span> (prop) {
      <span class="shj-syn-kwd">var</span> descriptor <span class="shj-syn-oper">=</span> <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">getOwnPropertyDescriptor</span>(ancestor<span class="shj-syn-oper">,</span> prop);
      <span class="shj-syn-class">Object</span><span class="shj-syn-oper">.</span><span class="shj-syn-func">defineProperty</span>(result<span class="shj-syn-oper">,</span> prop<span class="shj-syn-oper">,</span> descriptor);
    });
  });

  <span class="shj-syn-kwd">return</span> result;
}</div></div>
</code>
<p>Como al final el c칩digo ha quedado bastante m치s complejo de lo que me gustar칤a lo he apuntado en <a href="https://gist.github.com/amatiasq/5492466">un Gist</a> que podr칤a venirles bien.</p>
</div></article></div></body></html>